function PMClass(){"use strict";return PM?PM:(this._registeredListeners={},this._handlers={},this._iframes={},this.openMessages=0,this.authorizedUrls=[],this._defaultIntervalTimeout=100,this._intervalTimeout=this._defaultIntervalTimeout,this._maximumIntervals=50,this.init=function(){this._loadDefaultMethods(),this._createListener();var t=new this.Hash,e=this;t.keyExists("action")&&"postMessage"===t.get("action")&&this.addEventListener(window,"load",function(){if(t.keyExists("referrer")){var i=t.get("referrer"),r=e.parseUrl(i);window.parent.postMessage({action:"ready",handle:t.get("handle")},r.protocol+"//"+r.hostname+(r.port?":"+r.port:""))}})},this.initChildIframe=function(t){return this._handlers.parent=window.parent,this._iframes.parent={},this._iframes.parent.src=t,this},this._createListener=function(){var t=this;this.addEventListener(window,"message",function(e){if(!t.isAuthorizedUrl(e.origin))throw new Error(e.origin+" is not an authorized URL.");var i=e.data;t._handlePostMessageRequest(i,e)})},this._handlePostMessageRequest=function(t,e){if(!t.action)return!1;var i=t.action;if("function"!=typeof this._registeredListeners[i])return!1;"string"==typeof t&&(t=JSON.parseJSON(t));var r=this._registeredListeners[i].call(this,t,e);t.callback&&this._handlePMCallback(t,e,r),!t.callback&&t.deleteCallback&&delete this._registeredListeners[i]},this._handlePMCallback=function(t,e,i){"undefined"==typeof i&&(i=null);var r={action:t.callback,data:this.fixPMData(i),deleteCallback:t.deleteCallback||!1},s=e.origin;e.source.postMessage(r,s)},this._loadDefaultMethods=function(){this.registerListener("ready",function(t,e){this._handlers[t.handle]=e.source})},this.parseUrl=function(t){var e=document.createElement("a");return e.href=t,e},this.addAuthorizedUrl=function(t){if("[object Array]"===Object.prototype.toString.call(t))return this.addAuthorizedUrls(t);if("*"===t)this.authorizedUrls.push(t);else{var e=this.parseUrl(t),i=e.hostname+(e.port?":"+e.port:"");this.authorizedUrls.push(e.protocol+"//"+i)}return this},this.addAuthorizedUrls=function(t){if("[object Array]"!==Object.prototype.toString.call(t))throw"Invalid input. Not an array.";var e;for(e in t)t.hasOwnProperty(e)&&this.addAuthorizedUrl(t[e]);return this},this.isAuthorizedUrl=function(t){return this.authorizedUrls.indexOf("*")>-1||this.authorizedUrls.indexOf(t)>-1},this.clearAuthorizedUrls=function(){return this.authorizedUrls=[],this},this.removeAuthorizedUrl=function(t){return this.isAuthorizedUrl(t)?(this.authorizedUrls.splice(this.authorizedUrls.indexOf(t),1),this):!0},this.isHandlerReady=function(t){return!!this._handlers[t]},this.isIframeRegistered=function(t){return!!this._iframes[t]},this.preloadUrl=function(t,e){if(this.isAuthorizedUrl(e)||this.addAuthorizedUrl(e),this.isIframeRegistered(t))return this._iframes[t];var i=this.formatIframeUrl(t,e),r=document.createElement("iframe");r.style.display="none",r.id=t,r.src=i,this._iframes[t]=r;var s=function(){document.body.appendChild(r),document.removeEventListener("DOMContentLoaded",s,!1)};return document.body?document.body.appendChild(r):this.addEventListener(document,"DOMContentLoaded",s),r},this.preloadUrls=function(t){var e={};for(var i in t)t.hasOwnProperty(i)&&(e[i]=this.preloadUrl(i,t[i]));return e},this.formatIframeUrl=function(t,e){var i=this.parseUrl(e),r=i.hostname+(i.port?":"+i.port:""),s=i.hash,n="action=postMessage&referrer="+encodeURIComponent(window.location.href)+"&handle="+t;return""===s?s="#"+n:s+="&"+n,i.protocol+"//"+r+i.pathname+i.search+s},this.setMaxWaitTime=function(t){this._maximumIntervals=t/this._intervalTimeout},this.setIntervalTimeout=function(t){(!t||0>=t)&&(t=this._defaultIntervalTimeout),this._intervalTimeout=t},this.postMessage=function(t,e,i,r,s){if(!this.isIframeRegistered(t)&&s)this.preloadUrl(t,s),this.isHandlerReady(t)?this._postMessage(t,e,i,r):this._pmWait(t,e,i,r);else{if(!this.isIframeRegistered(t)&&!s)throw new Error("Unknown handle. Must include url for unknown handles.");this.isHandlerReady(t)?this._postMessage(t,e,i,r):this._pmWait(t,e,i,r)}},this._pmWait=function(t,e,i,r){var s=0,n=this,a=setInterval(function(){if(s++,s===n._maximumIntervals&&!n.isHandlerReady(t))throw clearInterval(a),new Error("PM: "+t+" timed out for action "+e+". Data not sent.");n.isHandlerReady(t)&&(clearInterval(a),n._postMessage(t,e,i,r))},this._intervalTimeout)},this._postMessage=function(t,e,i,r){var s={action:e,data:i,handle:t};if(r)if("function"==typeof r){var n="PM_"+(new Date).getTime();this.registerListener(n,r),s.callback=n,s.deleteCallback=!0}else s.callback=r;var a=this.parseUrl(this._iframes[t].src),o=a.hostname+(a.port?":"+a.port:""),h=a.protocol+"//"+o;s=this.fixPMData(s),this._handlers[t].postMessage(s,h)},this.fixPMData=function(t){return document.documentMode&&document.documentMode<10?void(t=JSON.stringify(t)):t},this.registerListener=function(t,e){if("function"!=typeof e)throw"Second parameter to registerListener must be a function!";return this._registeredListeners[t]=e,this},this.unregisterListener=function(t){return"undefined"==typeof this._registeredListeners[t]?this:(delete this._registeredListeners[t],this)},this.removePMIframe=function(t){if(!t||!t.id)return!1;var e=t.id;return this._iframes[e]&&(this._iframes[e].parentNode.removeChild(this._iframes[e]),delete this._iframes[e]),this._handlers[e]&&delete this._handlers[e],!0},this.removePMIframeByHandle=function(t){if(!this._iframes[t])return!1;var e=this._iframes[t];return this.removePMIframe(e)},this.removePMIframes=function(t){t||(t=this._iframes);var e=!0;for(var i in t)t.hasOwnProperty(i)&&(e=this.removePMIframe(t[i])&&e);return e},this.Hash=function(){var t=window.location.hash.replace(/(^#)|(#$)/,"");this.hashObj={};for(var e=t.split(/[#&]+/),i=0;i<e.length;i++)if("undefined"!=typeof e[i]&&""!==e[i]){var r=e[i].split("=");this.hashObj[r[0]]=r.length>1?decodeURIComponent(r[1]):decodeURIComponent(r[0]);try{this.hashObj[r[0]]=JSON.parse(this.hashObj[r[0]])}catch(s){}}return delete this.hash,delete this.hashArr,this.keyExists=function(t){return"undefined"!=typeof this.hashObj[t]},this.get=function(t){return this.hashObj[t]},this},this.addEventListener=function(t,e,i){var r="addEventListener",s="";window.addEventListener||(r="attachEvent",s="on"),t[r](s+e,function(t){i(t)})},this.init(),this)}var PM=new PMClass;