var PM=new (function(){if(PM){return PM}this._registeredListeners={};this._handlers={};this._iframes={};this.openMessages=0;this.authorizedUrls=[];this._defaultIntervalTimeout=100;this._intervalTimeout=this._defaultIntervalTimeout;this._maximumIntervals=50;this.init=function(){this._loadDefaultMethods();this._createListener();var b=new this.Hash(),a=this;if(b.keyExists("action")&&b.get("action")==="postMessage"){this.addEventListener(window,"load",function(){if(b.keyExists("referrer")){var c=b.get("referrer");var d=a.parseUrl(c);window.parent.postMessage({action:"ready",handle:b.get("handle")},d.protocol+"//"+d.hostname+(d.port?":"+d.port:""))}})}};this.initChildIframe=function(a){this._handlers.parent=window.parent;this._iframes.parent={};this._iframes.parent.src=a;return this};this._createListener=function(){var a=this;this.addEventListener(window,"message",function(c){if(a.isAuthorizedUrl(c.origin)){var b=c.data;a._handlePostMessageRequest(b,c)}else{throw new Error(c.origin+" is not an authorized URL.")}})};this._handlePostMessageRequest=function(b,d){if(!b.action){return false}var c=b.action;if(typeof this._registeredListeners[c]!=="function"){return false}if(typeof b==="string"){b=$.parseJSON(b)}var a=this._registeredListeners[c].call(this,b,d);if(b.callback){this._handlePMCallback(b,d,a)}if(b.deleteCallback){delete this._registeredListeners[c]}};this._handlePMCallback=function(c,d,a){if(typeof a==="undefined"){a=null}var f={action:c.callback,data:this.fixPMData(a)};if(c.deleteCallback){f.deleteCallback=true}var b=d.origin;d.source.postMessage(f,b);return};this._loadDefaultMethods=function(){var a=this;this.registerListener("ready",function(b,c){this._handlers[b.handle]=c.source})};this.parseUrl=function(c){var b=document.createElement("a");b.href=c;return b};this.addAuthorizedUrl=function(a){if(Object.prototype.toString.call(a)==="[object Array]"){return this.addAuthorizedUrls(a)}if(a==="*"){this.authorizedUrls.push(a)}else{var b=this.parseUrl(a);domainPart=b.hostname+(b.port?":"+b.port:"");this.authorizedUrls.push(b.protocol+"//"+domainPart)}return this};this.addAuthorizedUrls=function(a){if(Object.prototype.toString.call(a)!=="[object Array]"){throw"Invalid input. Not an array."}var b;for(b in a){this.addAuthorizedUrl(a[b])}return this};this.isAuthorizedUrl=function(a){return this.authorizedUrls.indexOf("*")>-1||this.authorizedUrls.indexOf(a)>-1};this.clearAuthorizedUrls=function(){this.authorizedUrls=[];return this};this.removeAuthorizedUrl=function(a){if(!this.isAuthorizedUrl(a)){return true}this.authorizedUrls.splice(this.authorizedUrls.indexOf(a),1);return this};this.isHandlerReady=function(a){return(!!this._handlers[a])};this.isIframeRegistered=function(a){return(!!this._iframes[a])};this.preloadUrl=function(d,b){if(!this.isAuthorizedUrl(b)){this.addAuthorizedUrl(b)}if(this.isIframeRegistered(d)){return this._iframes[d]}var a=this.formatIframeUrl(d,b);var c=document.createElement("iframe");c.style.display="none";c.id=d;c.src=a;this._iframes[d]=c;var e=function(){document.body.appendChild(c);document.removeEventListener("DOMContentLoaded",e,false)};if(!document.body){this.addEventListener(document,"DOMContentLoaded",e)}else{document.body.appendChild(c)}return c};this.preloadUrls=function(b){var c={};for(var a in b){if(!b.hasOwnProperty(a)){continue}c[a]=this.preloadUrl(a,b[a])}return c};this.formatIframeUrl=function(e,a){var d=this.parseUrl(a);var b=d.hostname+(d.port?":"+d.port:"");var f=d.hash;var c="action=postMessage&referrer="+encodeURIComponent(window.location.href)+"&handle="+e;if(f===""){f="#"+c}else{f+="&"+c}return d.protocol+"//"+b+d.pathname+d.search+f};this.setMaxWaitTime=function(a){this._maximumIntervals=a/this._intervalTimeout};this.setIntervalTimeout=function(a){if(!a||a<=0){a=this._defaultIntervalTimeout}this._intervalTimeout=a};this.postMessage=function(e,d,c,a,b){if(!this.isIframeRegistered(e)&&b){this.preloadUrl(e,b);if(!this.isHandlerReady(e)){this._pmWait(e,d,c,a)}else{this._postMessage(e,d,c,a)}}else{if(!this.isIframeRegistered(e)&&!b){throw new Error("Unknown handle. Must include url for unknown handles.")}else{if(!this.isHandlerReady(e)){this._pmWait(e,d,c,a)}else{this._postMessage(e,d,c,a)}}}};this._pmWait=function(g,f,e,a){var d=0;var c=this;var b=setInterval(function(){d++;if(d===c._maximumIntervals&&!c.isHandlerReady(g)){clearInterval(b);throw new Error("PM: "+g+" timed out for action "+f+". Data not sent.")}else{if(c.isHandlerReady(g)){clearInterval(b);c._postMessage(g,f,e,a)}}},this._intervalTimeout)};this._postMessage=function(g,f,e,a){var h={action:f,data:e,handle:g};if(a){if(typeof a==="function"){callbackActionName="PM_"+(new Date()).getTime();this.registerListener(callbackActionName,a);h.callback=callbackActionName;h.deleteCallback=true}else{h.callback=a}}var b=this.parseUrl(this._iframes[g].src),d=b.hostname+(b.port?":"+b.port:""),c=b.protocol+"//"+d;h=this.fixPMData(h);this._handlers[g].postMessage(h,c)};this.fixPMData=function(a){if(document.documentMode&&document.documentMode<10){a=JSON.stringify(a)}else{return a}};this.registerListener=function(a,b){if(typeof b!=="function"){throw"Second parameter to registerListener must be a function!"}this._registeredListeners[a]=b;return this};this.unregisterListener=function(a){if(typeof this._registeredListeners[a]==="undefined"){return this}delete this._registeredListeners[a];return this};this.removePMIframe=function(a){if(!a||!a.id){return false}var b=a.id;if(this._iframes[b]){this._iframes[b].parentNode.removeChild(this._iframes[b]);delete this._iframes[b]}if(this._handlers[b]){delete this._handlers[b]}return true};this.removePMIframeByHandle=function(b){if(!this._iframes[b]){return false}var a=this._iframes[b];return this.removePMIframe(a)};this.removePMIframes=function(b){if(!b){b=this._iframes}var c=true;for(var a in b){if(!b.hasOwnProperty(a)){continue}c=this.removePMIframe(b[a])&&c}return c};this.Hash=function(){var f=window.location.hash.replace(/(^#)|(#$)/,"");this.hashObj={};var b=f.split(/[#&]+/);for(var c=0;c<b.length;c++){if(typeof b[c]==="undefined"||b[c]===""){continue}var a=b[c].split("=");this.hashObj[a[0]]=(a.length>1?decodeURIComponent(a[1]):decodeURIComponent(a[0]));try{this.hashObj[a[0]]=JSON.parse(this.hashObj[a[0]])}catch(d){}}delete this.hash;delete this.hashArr;this.keyExists=function(e){return(typeof this.hashObj[e]!=="undefined")};this.get=function(e){return this.hashObj[e]};return this};this.addEventListener=function(a,e,c){var d="addEventListener";var b="";if(!window.addEventListener){d="attachEvent";b="on"}a[d](b+e,function(f){c(f)})};this.init();return this})();