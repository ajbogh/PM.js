var PM=new (function(a){if(PM){return PM}this._registeredListeners={};this._handlers={};this._iframes={};this.openMessages=0;this.authorizedUrls=[];this._defaultIntervalTimeout=100;this._intervalTimeout=this._defaultIntervalTimeout;this._maximumIntervals=50;this.init=function(){this._loadDefaultMethods();this._createListener();var c=new this.Hash();var b=this;if(c.keyExists("action")&&c.get("action")==="postMessage"){a(window).on("load",function(){if(c.keyExists("referrer")){var d=c.get("referrer");var e=b.parseUrl(d);window.parent.postMessage({action:"ready",handle:c.get("handle")},e.protocol+"//"+e.hostname)}})}};this._createListener=function(){var b=this;a(window).on("message",function(d){if(b.isAuthorizedUrl(d.originalEvent.origin)){var c=d.originalEvent.data;b._handlePostMessageRequest(c,d)}else{throw new Error(d.originalEvent.origin+" is not an authorized URL.")}})};this._handlePostMessageRequest=function(c,f){if(!c.action){return false}var d=c.action;if(typeof this._registeredListeners[d]!=="function"){return false}if(typeof c==="string"){c=a.parseJSON(c)}var b=this._registeredListeners[d].call(this,c,f);if(c.callback){this._handlePMCallback(c,f,b)}if(c.deleteCallback){delete this._registeredListeners[d]}};this._handlePMCallback=function(d,f,b){if(typeof b==="undefined"){b=null}var g={action:d.callback,data:this.fixPMData(b)};if(d.deleteCallback){g.deleteCallback=true}var c=f.originalEvent.origin;f.originalEvent.source.postMessage(g,c);return};this._loadDefaultMethods=function(){var b=this;this.registerListener("ready",function(c,d){this._handlers[c.handle]=d.originalEvent.source})};this.parseUrl=function(c){var b=document.createElement("a");b.href=c;return b};this.addAuthorizedUrl=function(b){if(Object.prototype.toString.call(b)==="[object Array]"){this.addAuthorizedUrls(b);return}if(b==="*"){this.authorizedUrls.push(b)}else{var c=this.parseUrl(b);domainPart=c.hostname+(c.port?":"+c.port:"");this.authorizedUrls.push(c.protocol+"//"+domainPart)}};this.addAuthorizedUrls=function(b){if(Object.prototype.toString.call(b)!=="[object Array]"){throw"Invalid input. Not an array."}var c;for(c in b){this.addAuthorizedUrl(b[c])}};this.isAuthorizedUrl=function(b){return this.authorizedUrls.indexOf("*")>-1||this.authorizedUrls.indexOf(b)>-1};this.clearAuthorizedUrls=function(){this.authorizedUrls=[]};this.removeAuthorizedUrl=function(b){if(!this.isAuthorizedUrl(b)){return true}this.authorizedUrls.splice(this.authorizedUrls.indexOf(b),1)};this.isHandlerReady=function(b){return(!!this._handlers[b])};this.isIframeRegistered=function(b){return(!!this._iframes[b])};this.preloadUrl=function(e,c){if(!this.isAuthorizedUrl(c)){this.addAuthorizedUrl(c)}if(this.isIframeRegistered(e)){return this._iframes[e]}var b=this.formatIframeUrl(e,c);var d=document.createElement("iframe");d.style.display="none";d.id=e;d.src=b;this._iframes[e]=d;document.body.appendChild(d);return d};this.preloadUrls=function(c){var d={};for(var b in c){if(!c.hasOwnProperty(b)){continue}d[b]=this.preloadUrl(b,c[b])}return d};this.formatIframeUrl=function(f,b){var e=this.parseUrl(b);var c=e.hostname+(e.port?":"+e.port:"");var g=e.hash;var d="action=postMessage&referrer="+encodeURIComponent(window.location.href)+"&handle="+f;if(g===""){g="#"+d}else{g+="&"+d}return e.protocol+"//"+c+e.pathname+e.search+g};this.setMaxWaitTime=function(b){this._maximumIntervals=b/this._intervalTimeout};this.setIntervalTimeout=function(b){if(!b||b<=0){b=this._defaultIntervalTimeout}this._intervalTimeout=b};this.postMessage=function(f,e,d,b,c){if(!this.isIframeRegistered(f)&&c){this.preloadUrl(f,c);if(!this.isHandlerReady(f)){this._pmWait(f,e,d,b)}else{this._postMessage(f,e,d,b)}}else{if(!this.isIframeRegistered(f)&&!c){throw new Error("Unknown handle. Must include url for unknown handles.")}else{if(!this.isHandlerReady(f)){this._pmWait(f,e,d,b)}else{this._postMessage(f,e,d,b)}}}};this._pmWait=function(h,g,f,b){var e=0;var d=this;var c=setInterval(function(){e++;if(e===d._maximumIntervals&&!d.isHandlerReady(h)){clearInterval(c);throw new Error("PM: "+h+" timed out for action "+g+". Data not sent.")}else{if(d.isHandlerReady(h)){clearInterval(c);d._postMessage(h,g,f,b)}}},this._intervalTimeout)};this._postMessage=function(h,g,f,b){var i={action:g,data:f,handle:h};if(b){if(typeof b==="function"){callbackActionName="PM_"+(new Date()).getTime();this.registerListener(callbackActionName,b);i.callback=callbackActionName;i.deleteCallback=true}else{i.callback=b}}var c=this.parseUrl(this._iframes[h].src),e=c.hostname+(c.port?":"+c.port:""),d=c.protocol+"//"+e;i=this.fixPMData(i);this._handlers[h].postMessage(i,d)};this.fixPMData=function(b){if(document.documentMode&&document.documentMode<10){b=this.toJSON(b)}else{return b}};this.registerListener=function(b,c){if(typeof c!=="function"){throw"Second parameter to registerListener must be a function!"}this._registeredListeners[b]=c;return this};this.unregisterListener=function(b){if(typeof this._registeredListeners[b]==="undefined"){return this}delete this._registeredListeners[b];return this};this.removePMIframe=function(b){if(!b){return false}b.parentNode.removeChild(b);delete this._handlers[b.id];return true};this.removePMIframeByHandle=function(c){if(!this._handlers[c]){return false}var b=this._handlers[c];return this.removePMIframe(b)};this.removePMIframes=function(b){if(!b){b=this._handlers}var d=true;for(var c in b){if(!b.hasOwnProperty(c)){continue}d=this.removePMIframe(b[c])&&d}return d};this.Hash=function(){var g=window.location.hash.replace(/(^#)|(#$)/,"");this.hashObj={};var c=g.split(/[#&]+/);for(var d=0;d<c.length;d++){if(typeof c[d]==="undefined"||c[d]===""){continue}var b=c[d].split("=");this.hashObj[b[0]]=(b.length>1?decodeURIComponent(b[1]):decodeURIComponent(b[0]));try{this.hashObj[b[0]]=a.parseJSON(this.hashObj[b[0]])}catch(f){}}delete this.hash;delete this.hashArr;this.keyExists=function(e){return(typeof this.hashObj[e]!=="undefined")};this.get=function(e){return this.hashObj[e]};return this};this.toJSON=typeof JSON==="object"&&JSON.stringify?JSON.stringify:function(d){if(d===null){return"null"}var c,g,b,e,l=a.type(d);if(l==="undefined"){return undefined}if(l==="number"||l==="boolean"){return String(d)}if(l==="string"){return a.quoteString(d)}if(typeof d.toJSON==="function"){return a.toJSON(d.toJSON())}if(l==="date"){var i=d.getUTCMonth()+1,m=d.getUTCDate(),j=d.getUTCFullYear(),n=d.getUTCHours(),f=d.getUTCMinutes(),p=d.getUTCSeconds(),h=d.getUTCMilliseconds();if(i<10){i="0"+i}if(m<10){m="0"+m}if(n<10){n="0"+n}if(f<10){f="0"+f}if(p<10){p="0"+p}if(h<100){h="0"+h}if(h<10){h="0"+h}return'"'+j+"-"+i+"-"+m+"T"+n+":"+f+":"+p+"."+h+'Z"'}c=[];if(a.isArray(d)){for(g=0;g<d.length;g++){c.push(a.toJSON(d[g])||"null")}return"["+c.join(",")+"]"}if(typeof d==="object"){for(g in d){if(hasOwn.call(d,g)){l=typeof g;if(l==="number"){b='"'+g+'"'}else{if(l==="string"){b=a.quoteString(g)}else{continue}}l=typeof d[g];if(l!=="function"&&l!=="undefined"){e=a.toJSON(d[g]);c.push(b+":"+e)}}}return"{"+c.join(",")+"}"}};this.init();return this})(jQuery);