function PMClass(){"use strict";return this._registeredListeners={},this._handlers={},this._iframes={},this.openMessages=0,this.authorizedUrls=[],this._defaultIntervalTimeout=100,this._intervalTimeout=this._defaultIntervalTimeout,this._maximumIntervals=50,this.initChildIframe=function(parentUrl){return this._handlers.parent=window.opener||window.parent,this._iframes.parent={},this._iframes.parent.src=parentUrl,this},this.init=function(){this._loadDefaultMethods(),this._createListener();var hash=new this.Hash,self=this;hash.keyExists("action")&&"postMessage"===hash.get("action")&&this.addEventListener(window,"load",function(){var referrer;hash.keyExists("referrer")&&(referrer=hash.get("referrer"),referrer=(referrer=self.parseUrl(referrer)).protocol+"//"+referrer.hostname+(referrer.port?":"+referrer.port:""),window.parent.postMessage({action:"ready",handle:hash.get("handle")},referrer),self.initChildIframe(referrer))})},this._createListener=function(){var self=this;this.addEventListener(window,"message",function(e){if(!self.isAuthorizedUrl(e.origin))throw new Error(e.origin+" is not an authorized URL.");var oeData=e.data;self._handlePostMessageRequest(oeData,e)})},this._handlePostMessageRequest=function(oeData,e){if(!oeData.action)return!1;var action=oeData.action;if("function"!=typeof this._registeredListeners[action])return!1;"string"==typeof oeData&&(oeData=JSON.parseJSON(oeData));var result=this._registeredListeners[action].call(this,oeData,e);oeData.callback&&this._handlePMCallback(oeData,e,result),!oeData.callback&&oeData.deleteCallback&&delete this._registeredListeners[action]},this._handlePMCallback=function(oeData,e,result){result={action:oeData.callback,data:this.fixPMData(result=void 0===result?null:result),deleteCallback:oeData.deleteCallback||!1},oeData=e.origin;e.source.postMessage(result,oeData)},this._loadDefaultMethods=function(){this.registerListener("ready",function(data,e){this._handlers[data.handle]=e.source})},this.parseUrl=function(url){var a=document.createElement("a");return a.href=url,a},this.addAuthorizedUrl=function(url){var domainPart;return"[object Array]"===Object.prototype.toString.call(url)?this.addAuthorizedUrls(url):("*"===url?this.authorizedUrls.push(url):(domainPart=(url=this.parseUrl(url)).hostname+(url.port?":"+url.port:""),this.authorizedUrls.push(url.protocol+"//"+domainPart)),this)},this.addAuthorizedUrls=function(urlArray){if("[object Array]"!==Object.prototype.toString.call(urlArray))throw"Invalid input. Not an array.";for(var i in urlArray)Object.prototype.hasOwnProperty.call(urlArray,i)&&this.addAuthorizedUrl(urlArray[i]);return this},this.isAuthorizedUrl=function(url){return-1<this.authorizedUrls.indexOf("*")||-1<this.authorizedUrls.indexOf(url)},this.clearAuthorizedUrls=function(){return this.authorizedUrls=[],this},this.removeAuthorizedUrl=function(url){return!this.isAuthorizedUrl(url)||(this.authorizedUrls.splice(this.authorizedUrls.indexOf(url),1),this)},this.isHandlerReady=function(handle){return!!this._handlers[handle]},this.isIframeRegistered=function(handle){return!!this._iframes[handle]},this.preloadUrl=function(handle,url){var iframe,listenerFunction;return this.isAuthorizedUrl(url)||this.addAuthorizedUrl(url),this.isIframeRegistered(handle)?this._iframes[handle]:(url=this.formatIframeUrl(handle,url),(iframe=document.createElement("iframe")).style.display="none",iframe.id=handle,iframe.src=url,this._iframes[handle]=iframe,listenerFunction=function(){document.body.appendChild(iframe),document.removeEventListener("DOMContentLoaded",listenerFunction,!1)},document.body?document.body.appendChild(iframe):this.addEventListener(document,"DOMContentLoaded",listenerFunction),iframe)},this.preloadUrls=function(urls){var i,iframeObj={};for(i in urls)Object.prototype.hasOwnProperty.call(urls,i)&&(iframeObj[i]=this.preloadUrl(i,urls[i]));return iframeObj},this.formatIframeUrl=function(handle,url){var url=this.parseUrl(url),domainPart=url.hostname+(url.port?":"+url.port:""),hash=url.hash,handle="action=postMessage&referrer="+encodeURIComponent(window.location.href)+"&handle="+handle;return""===hash?hash="#"+handle:hash+="&"+handle,url.protocol+"//"+domainPart+url.pathname+url.search+hash},this.setMaxWaitTime=function(millis){this._maximumIntervals=millis/this._intervalTimeout},this.setIntervalTimeout=function(millis){(!millis||millis<=0)&&(millis=this._defaultIntervalTimeout),this._intervalTimeout=millis},this.postMessage=function(handle,action,data,callbackAction,url){if(!this.isIframeRegistered(handle)&&url)this.preloadUrl(handle,url);else if(!this.isIframeRegistered(handle)&&!url)throw new Error("Unknown handle. Must include url for unknown handles.");this.isHandlerReady(handle)?this._postMessage(handle,action,data,callbackAction):this._pmWait(handle,action,data,callbackAction)},this.send=function(handle,action,data,callbackAction,url){this.postMessage(handle,action,data,callbackAction,url)},this._pmWait=function(handle,action,data,callbackAction){var intervalCount=0,self=this,interval=setInterval(function(){if(++intervalCount===self._maximumIntervals&&!self.isHandlerReady(handle))throw clearInterval(interval),new Error("PM: "+handle+" timed out for action "+action+". Data not sent.");self.isHandlerReady(handle)&&(clearInterval(interval),self._postMessage(handle,action,data,callbackAction))},this._intervalTimeout)},this._postMessage=function(handle,action,data,callbackAction){action={action:action,data:data,handle:handle},callbackAction&&("function"==typeof callbackAction?(data="PM_"+(new Date).getTime(),this.registerListener(data,callbackAction),action.callback=data,action.deleteCallback=!0):action.callback=callbackAction),data=this.parseUrl(this._iframes[handle].src),callbackAction=data.hostname+(data.port?":"+data.port:""),data=data.protocol+"//"+callbackAction,action=this.fixPMData(action);this._handlers[handle].postMessage(action,data)},this.fixPMData=function(data){if(!(document.documentMode&&document.documentMode<10))return data;JSON.stringify(data)},this.registerListener=function(actionName,func){if("function"!=typeof func)throw"Second parameter to registerListener must be a function!";return this._registeredListeners[actionName]=func,this},this.on=function(actionName,func){return this.registerListener(actionName,func)},this.unregisterListener=function(actionName){return void 0!==this._registeredListeners[actionName]&&delete this._registeredListeners[actionName],this},this.off=function(actionName){return this.unregisterListener(actionName)},this.removePMIframe=function(iframe){return!(!iframe||!iframe.id)&&(iframe=iframe.id,this._iframes[iframe]&&(this._iframes[iframe].parentNode.removeChild(this._iframes[iframe]),delete this._iframes[iframe]),this._handlers[iframe]&&delete this._handlers[iframe],!0)},this.removePMIframeByHandle=function(handle){return!!this._iframes[handle]&&(handle=this._iframes[handle],this.removePMIframe(handle))},this.removePMIframes=function(iframes){var i,success=!0;for(i in iframes=iframes||this._iframes)Object.prototype.hasOwnProperty.call(iframes,i)&&(success=this.removePMIframe(iframes[i])&&success);return success},this.Hash=function(){for(var hash=window.location.hash.replace(/(^#)|(#$)/,""),hashArr=(this.hashObj={},hash.split(/[#&]+/)),i=0;i<hashArr.length;i++)if(void 0!==hashArr[i]&&""!==hashArr[i]){var currentHashArr=hashArr[i].split("=");this.hashObj[currentHashArr[0]]=1<currentHashArr.length?decodeURIComponent(currentHashArr[1]):decodeURIComponent(currentHashArr[0]);try{this.hashObj[currentHashArr[0]]=JSON.parse(this.hashObj[currentHashArr[0]])}catch(e){}}return delete this.hash,delete this.hashArr,this.keyExists=function(key){return void 0!==this.hashObj[key]},this.get=function(key){return this.hashObj[key]},this},this.addEventListener=function(element,method,func){var eventMethod="addEventListener",prependMethod="";window.addEventListener||(eventMethod="attachEvent",prependMethod="on"),element[eventMethod](prependMethod+method,function(e){func(e)})},this.init(),this}const PM=new PMClass;export{PM};